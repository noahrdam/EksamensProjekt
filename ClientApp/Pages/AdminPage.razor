@page "/admin"
@using Core.Model
@inject HttpClient httpClient
@inject NavigationManager NavigationManager

<h1>Alle ansøgninger</h1>

<div style="text-align: right;">
<button id="navigate" class="bi bi-arrow-right-circle-fill" @onclick=ToYouthPage>  Til frivilige 16-18</button>
</div>

<div>
    <h3>Uger:</h3>
    @foreach (var week in weeks)
    {
        <button @onclick="() => FilterApplicationsByWeek(week)" class="btn btn-primary m-1">Uge @week</button>
    }
</div>

@if (selectedWeek.HasValue)
{
    <div>
        <h3>Perioder i uge @selectedWeek:</h3>
        @foreach (var period in GetPeriodsForWeek(selectedWeek.Value))
        {
            <button @onclick="() => FilterApplicationsByPeriod(period.EventId)" class="btn btn-secondary m-1">@period.From - @period.To</button>
        }
    </div>
}

@if (applications == null)
{
    <p><em>Loading...</em></p>
}
else if (!filteredApplications.Any())
{
    <p><em>No applications found.</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Kræv Nummer</th>
                <th>Forældre navn</th>
                <th>Mail</th>
                <th>Barnets navn</th>
                <th>Alder</th>
                <th>Tøjstørrelse</th>
                <th>Interesser</th>
                <th>Første prio</th>
                <th>Anden prio</th>
                <th>Samtykke</th> 
            </tr>
        </thead>
        <tbody>
            @foreach (var ap in filteredApplications)
            {
                <tr>
                    <td>@ap.ParentVolunteer.CrewNumber</td>
                    <td>@ap.ParentVolunteer.Name</td>
                    <td>@ap.ParentVolunteer.Mail</td>
                    <td>@ap.ParentVolunteer.Children[0].Name</td>
                    <td>@ap.ParentVolunteer.Children[0].Age</td>
                    <td>@ap.ParentVolunteer.Children[0].ClothingSize</td>
                    <td>@ap.ParentVolunteer.Children[0].Interests</td>
                    <td>@ap.FirstPrio.From - @ap.FirstPrio.To (Uge @ap.FirstPrio.Week)</td>
                    <td>@ap.SecondPrio.From - @ap.SecondPrio.To (Uge @ap.SecondPrio.Week)</td>
                    <td>
                        @if (!string.IsNullOrEmpty(ap.ConsentForm))
                        {
                            <img src="@ap.ConsentForm" alt="Signature" style="width:200px; height:100px;" />
                        }
                        else
                        {
                            <p>No signature</p>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Application> applications;
    private List<Application> filteredApplications;
    private List<Event> events;
    private int? selectedWeek;
    private int? selectedPeriod;
    private string serverURL = "https://localhost:7095/";
    private List<int> weeks = new List<int> { 27, 28, 30, 31 };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        applications = await httpClient.GetFromJsonAsync<List<Application>>($"{serverURL}api/aps/getall");
        events = await httpClient.GetFromJsonAsync<List<Event>>($"{serverURL}api/aps/getallevents");
        filteredApplications = applications;
    }

    private void FilterApplicationsByWeek(int week)
    {
        selectedWeek = week;
        selectedPeriod = null;
        FilterApplications();
    }

    private void FilterApplicationsByPeriod(int eventId)
    {
        selectedPeriod = eventId;
        FilterApplications();
    }

    private void FilterApplications()
    {
        if (selectedWeek.HasValue)
        {
            filteredApplications = applications
                .Where(ap => ap.FirstPrio.Week == selectedWeek.Value)
                .ToList();

            if (selectedPeriod.HasValue)
            {
                filteredApplications = filteredApplications
                    .Where(ap => ap.FirstPrio.EventId == selectedPeriod.Value)
                    .ToList();
            }
        }
        else
        {
            filteredApplications = applications;
        }
    }

    private List<Event> GetPeriodsForWeek(int week)
    {
        return events.Where(e => e.Week == week).ToList();
    }

    private async Task ToYouthPage()
    {
        NavigationManager.NavigateTo("/youth", forceLoad: true);
    }
}
